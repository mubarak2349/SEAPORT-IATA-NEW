<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>SEAPORT AIR DIV â€“ CASS PAYMENT DETAILS</title>

<style>
/* ===== Flying Logo (NO rectangle) ===== */
.bg-flight {
    position: fixed;
    width: 260px;
    height: 110px;
    opacity: 0.14;
    pointer-events: none;
    z-index: 0;
    clip-path: polygon(
     5% 50%, 15% 35%, 40% 30%, 
     70% 20%, 95% 50%, 
     70% 80%, 40% 70%, 15% 65%
);
    transition: transform 5s linear, top 5s linear, left 5s linear;
}
.logo {width: 100%;height: 100%;position: relative;}
.blue {position: absolute;width: 55%;height: 100%;background: #0a4fd6;clip-path: polygon(0 10%, 85% 0, 45% 100%, 0 90%);}
.white {position: absolute;width: 70%;height: 100%;left: 30%;background: white;clip-path: polygon(20% 0, 60% 0, 40% 50%,60% 100%, 20% 100%, 40% 50%);}
.dark {position: absolute;width: 55%;height: 100%;right: 0;background: #2f2f2f;clip-path: polygon(15% 0, 100% 50%, 15% 100%);}
</style>

<style>
:root{--bg:#020617;--panel:#020617;--card:#0b1220;--border:#1f2937;--txt:#e5e7eb;--muted:#9ca3af;--green:#22c55e;--amber:#f59e0b;--red:#ef4444;--blue:#38bdf8;--purple:#a78bfa;--current:#1e3a8a;--next:#0f766e;}
.light{--bg:#f8fafc;--panel:#ffffff;--card:#ffffff;--border:#e5e7eb;--txt:#020617;--muted:#475569;--current:#eef2ff;--next:#ecfeff;}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,Segoe UI,Arial;background:radial-gradient(circle at top,var(--card),var(--bg) 70%);color:var(--txt);}
header{display:flex;align-items:center;gap:12px;padding:16px 22px;background:var(--panel);box-shadow:0 20px 60px rgba(0,0,0,.4);position:sticky;top:0;z-index:10;}
header h3{margin:0;font-size:20px;font-weight:700}
.theme-btn{margin-left:auto;padding:6px 12px;border-radius:14px;border:1px solid var(--border);background:var(--card);color:var(--txt);cursor:pointer;font-size:12px;}
.watermark{margin-left:10px;font-size:12px;opacity:.6}
.dashboard{padding:20px;display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;}
.card{background:linear-gradient(180deg,var(--card),var(--bg));border-radius:18px;padding:16px;box-shadow:0 25px 70px rgba(0,0,0,.45);}
.card h4{margin:0;font-size:12px;color:var(--muted);text-transform:uppercase}
.card p{margin:6px 0;font-size:24px;font-weight:700}
.wave{height:8px;border-radius:20px;background:var(--bg);overflow:hidden}
.wave span{display:block;height:100%;background:linear-gradient(90deg,var(--blue),var(--purple));transition:width 1s ease}
.filter-bar{padding:0 20px 10px}
select{padding:6px 10px;border-radius:10px;background:var(--card);color:var(--txt);border:1px solid var(--border);}
.container{padding:0 20px 30px}
.table-wrap{background:var(--panel);border-radius:22px;box-shadow:0 40px 120px rgba(0,0,0,.5);overflow:auto;}
table{width:100%;border-collapse:collapse;font-size:12px}
th{padding:12px;background:var(--panel);border-bottom:1px solid var(--border);text-transform:uppercase;}
td{padding:8px;border-bottom:1px solid var(--bg);text-align:center;}
tr.freeze{opacity:.45}
tr.current{background:var(--current)}
tr.next{background:var(--next)}
input{width:85px;padding:4px;text-align:right;background:var(--bg);color:var(--txt);border:1px solid var(--border);border-radius:6px;font-size:11px;}
input:disabled{opacity:.4}
.btn{padding:3px 6px;border-radius:6px;border:1px solid var(--border);background:linear-gradient(180deg,var(--card),var(--bg));color:var(--txt);font-size:9px;cursor:pointer;margin:1px;}
.paidCell{background:rgba(34,197,94,.25)}
.pendingCell{background:rgba(245,158,11,.25)}
.days-ok{color:var(--green)}
.days-warn{color:var(--amber)}
.days-over{color:var(--red)}
.donut{width:34px;height:34px;border-radius:50%;background:conic-gradient(var(--green) 0deg,var(--green) var(--a),var(--amber) var(--a),var(--amber) var(--b),var(--blue) var(--b),var(--blue) 360deg);margin:auto;}
.mini{display:flex;height:8px;border-radius:6px;overflow:hidden;background:var(--bg)}
.mini div:nth-child(1){background:var(--green)}
.mini div:nth-child(2){background:var(--amber)}
footer{text-align:center;padding:14px;font-size:12px;opacity:.6}
.loading { opacity: 0.6; pointer-events: none; }
.status-updating { animation: pulse 1s infinite; }
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
.btn-paid { background: rgba(34,197,94,.2) !important; border-color: var(--green) !important; }
.btn-pending { background: rgba(245,158,11,.2) !important; border-color: var(--amber) !important; }
</style>
</head>

<body>
<div class="bg-flight" id="bgFlight">
    <div class="logo">
        <div class="blue"></div>
        <div class="white"></div>
        <div class="dark"></div>
    </div>
</div>

<header>
 <h3>SEAPORT(Air division) - IATA Cass payment calendar</h3>
 <button class="theme-btn" onclick="toggleTheme()">ðŸŒ™ Mode of View ðŸŒž</button>
 <div class="watermark">Dev by Mcode Version 2.0 - Google Sheet Sync âœ…</div>
</header>

<div class="dashboard">
 <div class="card"><h4>Current Period Invoice</h4><p id="dInv">â‚¹0</p><div class="wave"><span id="wInv"></span></div></div>
 <div class="card"><h4>Current Period Pending</h4><p id="dPend">â‚¹0</p><div class="wave"><span id="wPend"></span></div></div>
 <div class="card"><h4>Remaining Balance</h4><p id="dRem">â‚¹0</p><div class="wave"><span id="wRem"></span></div></div>
 <div class="card"><h4>Total Borrowed</h4><p id="dBor">â‚¹0</p><div class="wave"><span id="wBor"></span></div></div>
 <div class="card"><h4>AVL Balance</h4><p id="dAVL">â‚¹0</p><div class="wave"><span id="wAVL"></span></div></div>
</div>

<div class="filter-bar">
 <select id="periodFilter" onchange="applyFilter()">
  <option value="ALL">All Periods</option>
 </select>
</div>

<div class="container">
<div class="table-wrap">
<table>
<thead>
<tr>
<th>Period</th><th>Invoice</th><th>Remittance</th><th>Days Left</th>
<th>Srilankan</th><th>STATUS</th>
<th>AirIndia</th><th>STATUS</th>
<th>Singapore</th><th>STATUS</th>
<th>Total</th><th>Paid</th><th>AVL</th><th>Borrowed</th><th>Remaining</th><th>Airline Split</th><th>Progress</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>
</div>

<footer>ðŸš€ Shared online via Google Sheets â€“ Free forever</footer>

<script>
/* ================= GOOGLE SHEET URL ================= */
const API_URL = "https://script.google.com/macros/s/AKfycbwH6OqMGCa_aTj_SjmMDRuwFObDyEaDT7YVBV05njQvyFdJ1SjEb90Ml-NcF4P5cxTd/exec";

/* ================= GLOBAL STATE ================= */
let store = {};
let periods = [
 ["20251102F","2025-12-09","2025-12-30"],
 ["20251201F","2025-12-25","2026-01-14"],
 ["20251202F","2026-01-08","2026-01-30"],
 ["20260101F","2026-01-25","2026-02-16"],
 ["20260102F","2026-02-07","2026-03-02"],
 ["20260201F","2026-02-24","2026-03-17"],
 ["20260202F","2026-03-07","2026-03-30"],
 ["20260301F","2026-03-25","2026-04-14"],
 ["20260302F","2026-04-09","2026-04-30"],
 ["20260401F","2026-04-25","2026-05-15"],
 ["20260402F","2026-05-07","2026-06-01"],
 ["20260501F","2026-05-27","2026-06-15"],
 ["20260502F","2026-06-09","2026-06-30"],
 ["20260601F","2026-06-25","2026-07-15"],
 ["20260602F","2026-07-09","2026-07-30"],
 ["20260701F","2026-07-25","2026-08-14"],
 ["20260702F","2026-08-07","2026-08-31"],
 ["20260801F","2026-08-26","2026-09-14"],
 ["20260802F","2026-09-09","2026-09-30"],
 ["20260901F","2026-09-24","2026-10-15"],
 ["20260902F","2026-10-08","2026-10-30"],
 ["20261001F","2026-10-25","2026-11-16"],
 ["20261002F","2026-11-07","2026-11-30"],
 ["20261101F","2026-11-25","2026-12-15"],
 ["20261102F","2026-12-09","2026-12-30"],
 ["20261201F","2026-12-24","2027-01-14"],
 ["20261202F","2027-01-07","2027-02-01"]
];
let today = new Date();
let ci = -1;
let isUpdating = false;

/* ================= THEME ================= */
if(localStorage.theme==="light") document.body.classList.add("light");
function toggleTheme(){
 document.body.classList.toggle("light");
 localStorage.theme = document.body.classList.contains("light") ? "light" : "dark";
}

/* ================= UTILS ================= */
function inr(x){ return "â‚¹" + (x || 0).toLocaleString("en-IN"); }
function fnLabel(code){
 const y = code.slice(0,4), m = code.slice(4,6), f = code.slice(6,7);
 const mn = ["","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
 return `${mn[+m]} ${y} â€“ ${f==="1" ? "1st" : "2nd"} FN`;
}

/* ================= GOOGLE SHEET IO ================= */
async function loadData() {
 try {
  const res = await fetch(API_URL);
  store = await res.json();
  renderTable();
 } catch(e) {
  store = {};
  renderTable();
 }
}

async function saveData(key=null){
 if(isUpdating) return;
 isUpdating = true;
 const payload = key ? { [key]: store[key] } : store;
 await fetch(API_URL,{
  method:"POST",
  body:JSON.stringify(payload)
 });
 isUpdating=false;
}

/* ================= EXISTING LOGIC ================= */
/* --- keep all your original functions here --- */
async function saveValue(code, field, value) {
 store[code] = store[code] || {};
 store[code][field] = +value.replace(/[^0-9]/g, "") || 0;
 await saveData(code);
 renderTable();
}

async function togglePaid(code, field, value) {
 store[code] = store[code] || {};
 store[code][field] = value;
 await saveData(code);
 renderTable();
}

function updateDashboard() {
 const dInv = document.getElementById("dInv"), dPend = document.getElementById("dPend");
 const dRem = document.getElementById("dRem"), dBor = document.getElementById("dBor"), dAVL = document.getElementById("dAVL");

 let dInvTotal = 0, dPendTotal = 0, dRemTotal = 0, dBorTotal = 0, dAVLTotal = 0;

 periods.forEach((p, i) => {
  if (i === ci) {
   const d = store[p[0]] || {};
   const sl = +d.sl || 0, ai = +d.ai || 0, sg = +d.sg || 0;
   const slp = d.slp || 0, aip = d.aip || 0, sgp = d.sgp || 0;
   const avl = +d.avl || 0;
   const inv = sl + ai + sg;
   const paid = (slp ? sl : 0) + (aip ? ai : 0) + (sgp ? sg : 0);
   const rem = inv - paid - avl;
   
   dInvTotal = inv; dPendTotal = inv - paid; dRemTotal = rem; dAVLTotal = avl;
  }
  const d = store[p[0]] || {};
  dBorTotal += +d.bor || 0;
 });

 dInv.textContent = inr(dInvTotal); dPend.textContent = inr(dPendTotal);
 dRem.textContent = inr(dRemTotal); dBor.textContent = inr(dBorTotal); dAVL.textContent = inr(dAVLTotal);

 function w(id, val, max) {
  const el = document.getElementById(id);
  if (el) el.style.width = Math.min(100, (val / (max || 1)) * 100) + "%";
 }
 w("wInv", dInvTotal, dInvTotal); w("wPend", dPendTotal, dInvTotal);
 w("wRem", dRemTotal, dInvTotal); w("wBor", dBorTotal, dBorTotal); w("wAVL", dAVLTotal, dInvTotal);
}

/* ================= TABLE RENDER ================= */
function renderTable() {
 const tb = document.getElementById("tbody");
 const periodFilter = document.getElementById("periodFilter");
 tb.innerHTML = ""; 
 periodFilter.innerHTML = '<option value="ALL">All Periods</option>';

 ci = periods.findIndex(p => new Date(p[2]) >= today);

 periods.forEach((p, i) => {
  const d = store[p[0]] || {};
  const sl = +d.sl || 0, ai = +d.ai || 0, sg = +d.sg || 0;
  const slp = d.slp || 0, aip = d.aip || 0, sgp = d.sgp || 0;
  const avl = +d.avl || 0, bor = +d.bor || 0;
  const inv = sl + ai + sg;
  const paid = (slp ? sl : 0) + (aip ? ai : 0) + (sgp ? sg : 0);
  const rem = inv - paid - avl;
  const days = Math.ceil((new Date(p[2]) - today) / 86400000);
  const dayCls = days < 0 ? "days-over" : days <= 17 ? "days-warn" : "days-ok";
  const a = (inv ? sl / inv * 360 : 0);
  const b = (inv ? (sl + ai) / inv * 360 : 0);

  const tr = document.createElement("tr");
  tr.className = i < ci ? "freeze" : i === ci ? "current" : i === ci + 1 ? "next" : "freeze";
  tr.dataset.period = p[0];

  tr.innerHTML = `
   <td>${fnLabel(p[0])}</td>
   <td>${p[1]}</td>
   <td>${p[2]}</td>
   <td class="${dayCls}">${days}</td>
   
   <td class="${slp ? 'paidCell' : 'pendingCell'}">
    <input ${i > ci + 1 ? "disabled" : ""} value="${sl}" onchange="saveValue('${p[0]}','sl',this.value)">
   </td>
   <td>
    <button class="btn ${slp ? 'btn-paid' : 'btn-pending'}" onclick="togglePaid('${p[0]}','slp',1)">Paid</button>
    <button class="btn ${slp ? 'btn-pending' : 'btn-paid'}" onclick="togglePaid('${p[0]}','slp',0)">Pending</button>
    <div class="status-updating">ðŸ“±</div>
   </td>
   
   <td class="${aip ? 'paidCell' : 'pendingCell'}">
    <input ${i > ci + 1 ? "disabled" : ""} value="${ai}" onchange="saveValue('${p[0]}','ai',this.value)">
   </td>
   <td>
    <button class="btn ${aip ? 'btn-paid' : 'btn-pending'}" onclick="togglePaid('${p[0]}','aip',1)">Paid</button>
    <button class="btn ${aip ? 'btn-pending' : 'btn-paid'}" onclick="togglePaid('${p[0]}','aip',0)">Pending</button>
    <div class="status-updating">ðŸ“±</div>
   </td>
   
   <td class="${sgp ? 'paidCell' : 'pendingCell'}">
    <input ${i > ci + 1 ? "disabled" : ""} value="${sg}" onchange="saveValue('${p[0]}','sg',this.value)">
   </td>
   <td>
    <button class="btn ${sgp ? 'btn-paid' : 'btn-pending'}" onclick="togglePaid('${p[0]}','sgp',1)">Paid</button>
    <button class="btn ${sgp ? 'btn-pending' : 'btn-paid'}" onclick="togglePaid('${p[0]}','sgp',0)">Pending</button>
    <div class="status-updating">ðŸ“±</div>
   </td>
   
   <td>${inr(inv)}</td>
   <td>${inr(paid)}</td>
   <td><input ${i > ci + 1 ? "disabled" : ""} value="${avl}" onchange="saveValue('${p[0]}','avl',this.value)"></td>
   <td><input ${i > ci + 1 ? "disabled" : ""} value="${bor}" onchange="saveValue('${p[0]}','bor',this.value)"></td>
   <td>${inr(rem)}</td>
   <td><div class="donut" style="--a:${a}deg;--b:${b}deg"></div></td>
   <td><div class="mini"><div style="width:${inv ? paid / inv * 100 : 0}%"></div><div style="width:${inv ? rem / inv * 100 : 0}%"></div></div></td>
  `;
  tb.appendChild(tr);

  const opt = document.createElement("option");
  opt.value = p[0]; opt.text = fnLabel(p[0]);
  periodFilter.appendChild(opt);
 });

 updateDashboard(); applyFilter(); 
 document.body.classList.remove("loading");
}

/* ================= FILTER ================= */
function applyFilter() {
 const v = document.getElementById("periodFilter").value;
 document.querySelectorAll("#tbody tr").forEach(r => {
  r.style.display = (v === "ALL" || r.dataset.period === v) ? "" : "none";
 });
}

/* ================= PLANE ANIMATION ================= */
const plane = document.getElementById("bgFlight");
let x = -30; let y = 30;
function fly() {
 x += 25 + Math.random() * 15; y += Math.random() * 8 - 4;
 if (x > 120) { x = -30; y = Math.random() * 60; }
 const bank = Math.random() * 12 - 6;
 plane.style.left = x + "vw"; plane.style.top = y + "vh";
 plane.style.transform = `rotate(${bank}deg)`; setTimeout(fly, 5000);
}
fly();

/* ================= INIT ================= */
loadData();

// ðŸ”¥ REALTIME POLLING (1 second)
setInterval(async () => {
 try {
  const res = await fetch(API_URL);
  const newData = await res.json();
  if (JSON.stringify(newData) !== JSON.stringify(store)) {
   store = newData;
   renderTable();
  }
 } catch(e) {}
}, 1000);
</script>

</body>
</html>


